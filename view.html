<!DOCTYPE html>
<html>
<head>
  <title>View Tasks</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .task {
      background: #fff;
      padding: 10px;
      margin-bottom: 10px;
      border-left: 4px solid #4CAF50;
    }
    .task-actions {
      margin-top: 10px;
    }
    .pagination {
      margin-top: 20px;
    }
    button {
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <h2>Your Tasks</h2>

  <label for="importanceFilter">Filter by Importance:</label>
  <select id="importanceFilter" onchange="loadTasks()">
    <option value="All">All</option>
    <option value="Low">Low</option>
    <option value="High">High</option>
  </select>

  <label for="difficultyFilter" style="margin-left: 20px;">Filter by Difficulty:</label>
  <select id="difficultyFilter" onchange="loadTasks()">
    <option value="All">All</option>
    <option value="Easy">Easy</option>
    <option value="Medium">Medium</option>
    <option value="Hard">Hard</option>
  </select>

  <div id="taskList"></div>

  <div class="pagination">
    <button onclick="prevPage()">Previous</button>
    <span id="pageNumber">Page 1</span>
    <button onclick="nextPage()">Next</button>
  </div>

  <button onclick="history.back()">Back</button>

  <script>
    const user = localStorage.getItem("currentUser");
    if (!user) location.href = "index.html";

    let allTasks = JSON.parse(localStorage.getItem("tasks_" + user)) || [];
    let currentPage = 1;
    const itemsPerPage = 5;

    function loadTasks() {
      const taskList = document.getElementById("taskList");
      const pageNumber = document.getElementById("pageNumber");
      const importance = document.getElementById("importanceFilter").value;
      const difficulty = document.getElementById("difficultyFilter").value;

      let filteredTasks = allTasks.filter(task => {
        const importanceMatch = importance === "All" || task.importance === importance;
        const difficultyMatch = difficulty === "All" || task.difficulty === difficulty;
        return importanceMatch && difficultyMatch;
      });

      const totalPages = Math.max(1, Math.ceil(filteredTasks.length / itemsPerPage));
      if (currentPage > totalPages) currentPage = totalPages;

      taskList.innerHTML = "";
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageTasks = filteredTasks.slice(start, end);
      pageNumber.textContent = `Page ${currentPage} of ${totalPages}`;

      if (pageTasks.length === 0) {
        taskList.innerHTML = "<p>No tasks found on this page.</p>";
        return;
      }

      pageTasks.forEach((task, i) => {
        const globalIndex = allTasks.indexOf(task);
        const taskDiv = document.createElement("div");
        taskDiv.className = "task";
        taskDiv.innerHTML = `
          <strong>${globalIndex + 1}. ${task.name}</strong><br/>
          Difficulty: ${task.difficulty}<br/>
          Importance: ${task.importance}<br/>
          Due Date: ${task.dueDate}<br/>
          Status: ${task.completed ? "✅ Completed" : "❌ Incomplete"}<br/>

          <div class="task-actions">
            <button onclick="showUpdateForm(${globalIndex})">Update</button>
            <button onclick="deleteTask(${globalIndex})">Delete</button>
          </div>

          <div id="updateForm${globalIndex}" style="display: none; margin-top: 10px;">
            <input type="text" id="name${globalIndex}" value="${task.name}" /><br/>
            <input type="date" id="date${globalIndex}" value="${task.dueDate}" /><br/>
            <select id="difficulty${globalIndex}">
              <option ${task.difficulty === "Easy" ? "selected" : ""}>Easy</option>
              <option ${task.difficulty === "Medium" ? "selected" : ""}>Medium</option>
              <option ${task.difficulty === "Hard" ? "selected" : ""}>Hard</option>
            </select><br/>
            <select id="importance${globalIndex}">
              <option ${task.importance === "Low" ? "selected" : ""}>Low</option>
              <option ${task.importance === "High" ? "selected" : ""}>High</option>
            </select><br/>
            <label>
              <input type="checkbox" id="completed${globalIndex}" ${task.completed ? "checked" : ""}/> Completed
            </label><br/>
            <button onclick="saveUpdate(${globalIndex})">Save</button>
            <button onclick="cancelUpdate(${globalIndex})">Cancel</button>
          </div>
        `;
        taskList.appendChild(taskDiv);
      });
    }

    function showUpdateForm(index) {
      document.getElementById(`updateForm${index}`).style.display = "block";
    }

    function cancelUpdate(index) {
      document.getElementById(`updateForm${index}`).style.display = "none";
    }

    function saveUpdate(index) {
      allTasks[index].name = document.getElementById(`name${index}`).value;
      allTasks[index].dueDate = document.getElementById(`date${index}`).value;
      allTasks[index].difficulty = document.getElementById(`difficulty${index}`).value;
      allTasks[index].importance = document.getElementById(`importance${index}`).value;
      allTasks[index].completed = document.getElementById(`completed${index}`).checked;

      localStorage.setItem("tasks_" + user, JSON.stringify(allTasks));
      alert("Task updated!");
      loadTasks();
    }

    function deleteTask(index) {
      if (!confirm("Are you sure you want to delete this task?")) return;

      allTasks.splice(index, 1);
      localStorage.setItem("tasks_" + user, JSON.stringify(allTasks));
      loadTasks();
    }

    function nextPage() {
      const importance = document.getElementById("importanceFilter").value;
      const difficulty = document.getElementById("difficultyFilter").value;

      const filtered = allTasks.filter(task =>
        (importance === "All" || task.importance === importance) &&
        (difficulty === "All" || task.difficulty === difficulty)
      );

      const totalPages = Math.ceil(filtered.length / itemsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        loadTasks();
      }
    }

    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        loadTasks();
      }
    }

    // Initial load
    loadTasks();
  </script>
</body>
</html>
